name: 'ğŸš€ GitHub â†’ Gitee åŒæ­¥ (coreä»“åº“)'

on:
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      
      source_folder:
        description: 'GitHubæºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      target_folder:
        description: 'Giteeç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      commit_message:
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date}ï¼‰'
        required: false
        default: 'ğŸ”„ ä»GitHubåŒæ­¥ {date} {time}'
        type: string

env:
  # æºä»“åº“ï¼ˆGitHubï¼‰
  GITHUB_USER: 'xiaoran67'
  GITHUB_REPO: 'core'
  GITHUB_BRANCH: 'main'
  GITHUB_TOKEN_SECRET: 'XIAORAN67_GITHUB_TOKEN'
  
  # ç›®æ ‡ä»“åº“ï¼ˆGiteeï¼‰
  GITEE_USER: 'xiaoran67'
  GITEE_REPO: 'core'
  GITEE_BRANCH: 'master'
  GITEE_TOKEN_SECRET: 'XIAORAN67_GITEE_TOKEN'

jobs:
  github-to-gitee-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # 1. æ˜¾ç¤ºåŒæ­¥ä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºåŒæ­¥é…ç½®
        run: |
          echo "========================================"
          echo "ğŸš€ GitHub â†’ Gitee åŒæ­¥é…ç½®"
          echo "========================================"
          echo "ğŸ“¥ æºä»“åº“ (GitHub):"
          echo "   ç”¨æˆ·: ${{ env.GITHUB_USER }}"
          echo "   ä»“åº“: ${{ env.GITHUB_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITHUB_BRANCH }}"
          echo "   Token: ${{ env.GITHUB_TOKEN_SECRET }}"
          echo ""
          echo "ğŸ“¤ ç›®æ ‡ä»“åº“ (Gitee):"
          echo "   ç”¨æˆ·: ${{ env.GITEE_USER }}"
          echo "   ä»“åº“: ${{ env.GITEE_REPO }}"
          echo "   åˆ†æ”¯: ${{ env.GITEE_BRANCH }}"
          echo "   Token: ${{ env.GITEE_TOKEN_SECRET }}"
          echo ""
          echo "âš™ï¸ åŒæ­¥è®¾ç½®:"
          echo "   æ¨¡å¼: ${{ github.event.inputs.sync_mode }}"
          echo "   æºæ–‡ä»¶å¤¹: ${{ github.event.inputs.source_folder || 'æ ¹ç›®å½•' }}"
          echo "   ç›®æ ‡æ–‡ä»¶å¤¹: ${{ github.event.inputs.target_folder || 'æ ¹ç›®å½•' }}"
          echo "========================================"

      # 2. æ ¡éªŒToken
      - name: ğŸ”‘ æ ¡éªŒToken
        run: |
          echo "=== æ ¡éªŒToken ==="
          
          # æ£€æŸ¥GitHub Token
          if [ -z "${{ secrets[env.GITHUB_TOKEN_SECRET] }}" ]; then
            echo "âŒ GitHub Tokenä¸å­˜åœ¨: ${{ env.GITHUB_TOKEN_SECRET }}"
            exit 1
          fi
          
          # æ£€æŸ¥Gitee Token
          if [ -z "${{ secrets[env.GITEE_TOKEN_SECRET] }}" ]; then
            echo "âŒ Gitee Tokenä¸å­˜åœ¨: ${{ env.GITEE_TOKEN_SECRET }}"
            exit 1
          fi
          
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 3. å®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync git

      # 4. ä»GitHubæ£€å‡ºæºä»“åº“
      - name: ğŸ“¥ ä»GitHubæ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_USER }}/${{ env.GITHUB_REPO }}
          ref: ${{ env.GITHUB_BRANCH }}
          path: github_repo
          token: ${{ secrets[env.GITHUB_TOKEN_SECRET] }}
          fetch-depth: 1
          clean: true

      # 5. ä»Giteeå…‹éš†ç›®æ ‡ä»“åº“
      - name: ğŸ“¥ å…‹éš†Giteeç›®æ ‡ä»“åº“
        run: |
          echo "=== å…‹éš†Giteeç›®æ ‡ä»“åº“ ==="
          GITEE_TOKEN="${{ secrets[env.GITEE_TOKEN_SECRET] }}"
          
          GITEE_URL="https://${{ env.GITEE_USER }}:$GITEE_TOKEN@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          
          set +e
          git clone --branch ${{ env.GITEE_BRANCH }} --depth=1 "$GITEE_URL" gitee_repo
          CLONE_STATUS=$?
          set -e
          
          if [ $CLONE_STATUS -eq 0 ]; then
            echo "âœ… Giteeä»“åº“å…‹éš†æˆåŠŸ"
          else
            echo "âš ï¸ Giteeä»“åº“å…‹éš†å¤±è´¥ï¼Œåˆå§‹åŒ–ç©ºä»“åº“..."
            rm -rf gitee_repo
            mkdir -p gitee_repo
            cd gitee_repo
            git init
            git remote add origin "$GITEE_URL"
            git checkout -b ${{ env.GITEE_BRANCH }} || git checkout -b main
            cd ..
          fi
          
          if [ -n "${{ github.event.inputs.target_folder }}" ]; then
            TARGET_FOLDER=$(echo "${{ github.event.inputs.target_folder }}" | sed 's|^/||' | sed 's|/$||')
            mkdir -p "gitee_repo/$TARGET_FOLDER"
          fi

      # 6. æ ¸å¿ƒåŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒæ ¡éªŒï¼‰
      - name: ğŸš€ æ‰§è¡ŒåŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒæ ¡éªŒï¼‰
        run: |
          # å®šä¹‰æº/ç›®æ ‡è·¯å¾„
          SOURCE_PATH="github_repo"
          TARGET_PATH="gitee_repo"
          
          if [ -n "${{ github.event.inputs.source_folder }}" ]; then
            SOURCE_FOLDER=$(echo "${{ github.event.inputs.source_folder }}" | sed 's|^/||' | sed 's|/$||')
            SOURCE_PATH="github_repo/$SOURCE_FOLDER"
          fi
          
          if [ -n "${{ github.event.inputs.target_folder }}" ]; then
            TARGET_FOLDER=$(echo "${{ github.event.inputs.target_folder }}" | sed 's|^/||' | sed 's|/$||')
            TARGET_PATH="gitee_repo/$TARGET_FOLDER"
          fi
          
          mkdir -p "$TARGET_PATH"
          
          export TZ='Asia/Shanghai'
          
          if [ "${{ github.event.inputs.sync_mode }}" = "å¢é‡" ]; then
            rsync -av --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          else
            rsync -av --delete --force --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          fi
          
          cd gitee_repo
          if git status --porcelain | grep -q .; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          fi

      # 7. æ¨é€æ›´æ–°
      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ç›®æ ‡ä»“åº“
        if: env.CHANGES_DETECTED == 'true'
        run: |
          cd gitee_repo
          
          if ! git status --porcelain | grep -q .; then
            echo "â„¹ï¸ æ— å®é™…å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add . --force
          
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          COMMIT_MSG="${COMMIT_MSG//\{time\}/$CURRENT_TIME}"
          COMMIT_MSG="${COMMIT_MSG//\{date\}/$CURRENT_DATE}"
          
          git commit -m "$COMMIT_MSG"
          PUSH_URL="https://${{ secrets[env.GITEE_TOKEN_SECRET] }}@gitee.com/${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}.git"
          git push "$PUSH_URL" ${{ env.GITEE_BRANCH }} ${{ github.event.inputs.sync_mode == 'è¦†ç›–' && '--force' || '' }}

      # 8. è¾“å‡ºåŒæ­¥ç»“æœ
      - name: ğŸ“Š åŒæ­¥ç»“æœæ±‡æ€»
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼"
            echo "ğŸ“Œ æºä»“åº“ï¼š${{ env.GITHUB_USER }}/${{ env.GITHUB_REPO }}:${{ env.GITHUB_BRANCH }}"
            echo "ğŸ“Œ ç›®æ ‡ä»“åº“ï¼š${{ env.GITEE_USER }}/${{ env.GITEE_REPO }}:${{ env.GITEE_BRANCH }}"
            echo "ğŸ“Œ åŒæ­¥è·¯å¾„ï¼š${{ github.event.inputs.source_folder || 'æ ¹ç›®å½•' }} â†’ ${{ github.event.inputs.target_folder || 'æ ¹ç›®å½•' }}"
          else
            echo "â„¹ï¸ æºæ–‡ä»¶ä¸ç›®æ ‡æ–‡ä»¶å®Œå…¨ä¸€è‡´ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒ¹é…ï¼‰ï¼Œæ— éœ€åŒæ­¥"
          fi

      # 9. å…¨å±€é”™è¯¯å¤„ç†
      - name: ğŸ” å…¨å±€å¼‚å¸¸å¤„ç†
        if: failure()
        run: |
          if [ "$CHANGES_DETECTED" = "false" ]; then
            echo "â„¹ï¸ æ— å˜æ›´ï¼Œæµç¨‹æ­£å¸¸ç»“æŸ"
            exit 0
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ’æŸ¥é—®é¢˜"
            exit 1
          fi
