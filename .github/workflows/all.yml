name: 'ğŸ”„ æ‰¹é‡è·¨ä»“åº“åŒæ­¥'

on:
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'æ˜¯å¦åŒæ­¥æ‰€æœ‰ä»“åº“'
        type: boolean
        required: true
        default: true
      specific_sync:
        description: 'é€‰æ‹©ç‰¹å®šåŒæ­¥ä»»åŠ¡ï¼ˆä»…å½“sync_all=falseæ—¶æœ‰æ•ˆï¼‰'
        type: choice
        required: false
        default: 'core'
        options:
          - 'core'
          - 'update'
          - 'xiaoran37'
          - 'xiaoran67'
      sync_strategy:
        description: 'åŒæ­¥ç­–ç•¥'
        type: choice
        required: true
        default: 'è¦†ç›–'
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
      commit_template:
        description: 'æäº¤ä¿¡æ¯æ¨¡æ¿'
        type: choice
        required: true
        default: 'ä»…æ—¶é—´'
        options:
          - 'ä»…æ—¶é—´'
          - 'åŒæ­¥è¯´æ˜'
          - 'è‡ªå®šä¹‰'
      custom_commit_msg:
        description: 'è‡ªå®šä¹‰æäº¤ä¿¡æ¯ï¼ˆé€‰"è‡ªå®šä¹‰"æ—¶å¡«å†™ï¼‰'
        type: string
        required: false
        default: ''

env:
  SOURCE_ACCOUNT: 'xiaoran67'
  TARGET_ACCOUNT: 'xiaoran37'
  SOURCE_TOKEN_NAME: 'XIAORAN67_GITHUB_TOKEN'
  TARGET_TOKEN_NAME: 'XIAORAN37_GITHUB_TOKEN'
  BRANCH: 'main'
  TARGET_PRIVATE: false

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { repo: 'core' }
          - { repo: 'update' }
          - { repo: 'xiaoran37' }
          - { repo: 'xiaoran67' }
    # ç§»é™¤å¤æ‚çš„ifæ¡ä»¶ï¼Œæ”¹ä¸ºåœ¨stepsä¸­æ§åˆ¶
    steps:
      # 0. æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œå½“å‰ä»“åº“çš„åŒæ­¥
      - name: ğŸ” æ£€æŸ¥æ‰§è¡Œæ¡ä»¶
        id: check_condition
        run: |
          REPO_NAME="${{ matrix.repo }}"
          
          # å¦‚æœé€‰æ‹©åŒæ­¥æ‰€æœ‰ï¼Œæˆ–è€…é€‰æ‹©ç‰¹å®šä»»åŠ¡ä¸”ä¸å½“å‰ä»“åº“åŒ¹é…
          if [ "${{ inputs.sync_all }}" = "true" ] || [ "${{ inputs.specific_sync }}" = "$REPO_NAME" ]; then
            echo "æ‰§è¡ŒåŒæ­¥ï¼š$REPO_NAME"
            echo "should_run=true" >> $GITHUB_ENV
          else
            echo "è·³è¿‡åŒæ­¥ï¼š$REPO_NAME"
            echo "should_run=false" >> $GITHUB_ENV
          fi

      # åªæœ‰should_run=trueæ—¶æ‰ç»§ç»­æ‰§è¡Œ
      - name: ğŸ§© è®¾ç½®ä»“åº“é…ç½®
        if: env.should_run == 'true'
        run: |
          echo "SOURCE_REPO=${{ env.SOURCE_ACCOUNT }}/${{ matrix.repo }}" >> $GITHUB_ENV
          echo "TARGET_REPO=${{ env.TARGET_ACCOUNT }}/${{ matrix.repo }}" >> $GITHUB_ENV

      # 2. è§£æé…ç½®ï¼ˆä¸¥æ ¼æ ¼å¼æ ¡éªŒï¼‰
      - name: ğŸ§© è§£æé…ç½®ä¿¡æ¯
        if: env.should_run == 'true'
        id: parse_config
        run: |
          echo "source_user=${{ env.SOURCE_ACCOUNT }}" >> $GITHUB_ENV
          echo "source_repo=${{ matrix.repo }}" >> $GITHUB_ENV
          echo "source_branch=${{ env.BRANCH }}" >> $GITHUB_ENV
          
          echo "target_user=${{ env.TARGET_ACCOUNT }}" >> $GITHUB_ENV
          echo "target_repo=${{ matrix.repo }}" >> $GITHUB_ENV
          echo "target_branch=${{ env.BRANCH }}" >> $GITHUB_ENV
          
          echo "source_token_name=${{ env.SOURCE_TOKEN_NAME }}" >> $GITHUB_ENV
          echo "target_token_name=${{ env.TARGET_TOKEN_NAME }}" >> $GITHUB_ENV

      # 3. æ ¡éªŒTokenï¼ˆé¿å…æ— æƒé™ï¼‰
      - name: ğŸ”‘ æ ¡éªŒTokenå­˜åœ¨æ€§
        if: env.should_run == 'true'
        run: |
          if [ -z "${{ secrets[env.SOURCE_TOKEN_NAME] }}" ]; then
            echo "âŒ é”™è¯¯ï¼šæºä»“åº“Tokenï¼ˆ${{ env.SOURCE_TOKEN_NAME }}ï¼‰ä¸å­˜åœ¨" && exit 1
          fi
          if [ -z "${{ secrets[env.TARGET_TOKEN_NAME] }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç›®æ ‡ä»“åº“Tokenï¼ˆ${{ env.TARGET_TOKEN_NAME }}ï¼‰ä¸å­˜åœ¨" && exit 1
          fi
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 4. æ£€æŸ¥/åˆ›å»ºç›®æ ‡ä»“åº“ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
      - name: ğŸ“¦ æ£€æŸ¥å¹¶åˆ›å»ºç›®æ ‡ä»“åº“
        if: env.should_run == 'true'
        run: |
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          REPO_CHECK_URL="https://api.github.com/repos/${{ env.target_user }}/${{ env.target_repo }}"
          REPO_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TARGET_TOKEN" "$REPO_CHECK_URL")
          
          if [ "$REPO_EXISTS" -eq 404 ]; then
            echo "â„¹ï¸ ç›®æ ‡ä»“åº“ ${{ env.target_repo }} ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»º..."
            CREATE_BODY=$(jq -n --arg name "${{ env.target_repo }}" --argjson private ${{ env.TARGET_PRIVATE }} --arg default_branch "${{ env.target_branch }}" '{
              "name": $name, "private": $private, "auto_init": true, "default_branch": $default_branch
            }')
            CREATE_RESPONSE=$(curl -s -w "%{http_code}" -o create_result.json -X POST \
              -H "Authorization: token $TARGET_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/user/repos" \
              -d "$CREATE_BODY")
            
            if [ "$CREATE_RESPONSE" -eq 201 ]; then
              echo "âœ… ç›®æ ‡ä»“åº“ ${{ env.target_repo }} åˆ›å»ºæˆåŠŸ"
            else
              echo "âŒ ç›®æ ‡ä»“åº“ ${{ env.target_repo }} åˆ›å»ºå¤±è´¥ï¼š$(cat create_result.json)" && exit 1
            fi
          elif [ "$REPO_EXISTS" -eq 200 ]; then
            echo "â„¹ï¸ ç›®æ ‡ä»“åº“ ${{ env.target_repo }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "âŒ æ£€æŸ¥ä»“åº“çŠ¶æ€å¤±è´¥ï¼ŒHTTPç ï¼š$REPO_EXISTS" && exit 1
          fi

      # 5. æ£€å‡ºæº/ç›®æ ‡ä»“åº“ï¼ˆç¡®ä¿æœ€æ–°ä»£ç ï¼‰
      - name: ğŸ“¥ æ£€å‡ºæºä»“åº“
        if: env.should_run == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.source_user }}/${{ env.source_repo }}
          ref: ${{ env.source_branch }}
          path: source_repo
          token: ${{ secrets[env.SOURCE_TOKEN_NAME] }}
          fetch-depth: 0
          clean: true

      - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
        if: env.should_run == 'true'
        run: |
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          git clone --branch ${{ env.target_branch }} \
            "https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git" \
            target_repo
          cd target_repo && git pull origin ${{ env.target_branch }} && cd ..
          echo "âœ… ç›®æ ‡ä»“åº“ ${{ env.target_repo }} æ£€å‡ºå®Œæˆ"

      # 6. å®‰è£…ä¾èµ–ï¼ˆä»…rsync+jqï¼Œè½»é‡é«˜æ•ˆï¼‰
      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        if: env.should_run == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y rsync jq

      # 7. æ ¸å¿ƒåŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒæ ¡éªŒï¼Œé«˜æ•ˆç²¾å‡†ï¼‰
      - name: ğŸš€ æ‰§è¡ŒåŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒæ ¡éªŒï¼‰
        if: env.should_run == 'true'
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥ï¼š${{ env.source_repo }}"
          
          # å®šä¹‰æº/ç›®æ ‡è·¯å¾„
          SOURCE_PATH="source_repo"
          TARGET_PATH="target_repo"
          
          # å…³é”®ï¼šç»Ÿä¸€æ—¶åŒº+ä¿ç•™æºæ–‡ä»¶æ—¶é—´æˆ³ï¼ˆé¿å…åç»­è¯¯åˆ¤ï¼‰
          export TZ='Asia/Shanghai'
          
          if [ "${{ inputs.sync_strategy }}" = "å¢é‡" ]; then
            echo "ğŸ“Š åŒæ­¥ç­–ç•¥ï¼šå¢é‡åŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°æ ¡éªŒï¼‰"
            # rsyncæ ¸å¿ƒé€»è¾‘ï¼šæ—¶é—´æˆ³ä¸åŒ æˆ– æ–‡ä»¶å¤§å°ä¸åŒ â†’ åŒæ­¥ï¼ˆç²¾å‡†é«˜æ•ˆï¼‰
            rsync -av --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          else
            echo "ğŸ“Š åŒæ­¥ç­–ç•¥ï¼šè¦†ç›–åŒæ­¥ï¼ˆå…¨é‡æ›¿æ¢ï¼‰"
            # è¦†ç›–åŒæ­¥ï¼šå…¨é‡æ›¿æ¢+æ¸…ç©ºç›®æ ‡å¤šä½™æ–‡ä»¶
            rsync -av --delete --force --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          fi
          
          # æ£€æµ‹å˜åŒ–ï¼ˆå«æ–°å¢ç›®å½•/æ–‡ä»¶ï¼‰
          cd target_repo
          if git status --porcelain | grep -q .; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
            echo "ğŸ”„ æ£€æµ‹åˆ°å˜æ›´"
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°å˜æ›´"
          fi

      # 8. æ¨é€æ›´æ–°ï¼ˆå®¹é”™å¤„ç†ï¼‰
      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ç›®æ ‡ä»“åº“
        if: env.should_run == 'true' && env.CHANGES_DETECTED == 'true'
        run: |
          cd target_repo
          echo "ğŸ”„ å‡†å¤‡æ¨é€ ${{ env.target_repo }}"
          
          # äºŒæ¬¡ç¡®è®¤å˜æ›´ï¼ˆé¿å…ç©ºæäº¤ï¼‰
          if ! git status --porcelain | grep -q .; then
            echo "â„¹ï¸ æ— å®é™…å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # é…ç½®Gitèº«ä»½
          git config user.name "Sync Bot"
          git config user.email "sync@noreply.github.com"
          git add . --force  # å¼ºåˆ¶æ·»åŠ æ–°å¢ç›®å½•/æ–‡ä»¶
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          SRC_INFO="${{ env.source_user }}/${{ env.source_repo }}:${{ env.source_branch }}"
          TGT_INFO="${{ env.target_user }}/${{ env.target_repo }}:${{ env.target_branch }}"
          
          if [ "${{ inputs.commit_template }}" = "ä»…æ—¶é—´" ]; then
            COMMIT_MSG="ğŸš€ ${{ env.target_repo }} ${CURRENT_DATE}"
          elif [ "${{ inputs.commit_template }}" = "åŒæ­¥è¯´æ˜" ]; then
            COMMIT_MSG="ğŸ”„ åŒæ­¥ï¼ˆ${{ inputs.sync_strategy }}ï¼‰ ${{ env.source_repo }} â†’ ${{ env.target_repo }}ï¼ˆ${CURRENT_DATE}ï¼‰"
          else
            COMMIT_MSG="${{ inputs.custom_commit_msg }}"
            [ -z "$COMMIT_MSG" ] && COMMIT_MSG="ğŸš€ ${{ env.target_repo }} ${CURRENT_DATE}"
          fi
          
          echo "ğŸ“ æäº¤ä¿¡æ¯ï¼š$COMMIT_MSG"
          
          # æäº¤å¹¶æ¨é€ï¼ˆè¦†ç›–ç­–ç•¥å¼ºåˆ¶æ¨é€ï¼‰
          git commit -m "$COMMIT_MSG"
          PUSH_URL="https://${{ secrets[env.target_token_name] }}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
          
          if [ "${{ inputs.sync_strategy }}" = 'è¦†ç›–' ]; then
            echo "âš¡ ä½¿ç”¨å¼ºåˆ¶æ¨é€ï¼ˆè¦†ç›–ç­–ç•¥ï¼‰"
            git push "$PUSH_URL" ${{ env.target_branch }} --force
          else
            echo "âš¡ ä½¿ç”¨æ™®é€šæ¨é€"
            git push "$PUSH_URL" ${{ env.target_branch }}
          fi
          
          echo "âœ… ${{ env.target_repo }} åŒæ­¥å®Œæˆ"

      # 9. è¾“å‡ºåŒæ­¥ç»“æœ
      - name: ğŸ“Š åŒæ­¥ç»“æœæ±‡æ€»
        if: env.should_run == 'true'
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "âœ… ${{ env.target_repo }} åŒæ­¥å®Œæˆï¼"
            echo "ğŸ“Œ æºä»“åº“ï¼š${{ env.source_user }}/${{ env.source_repo }}:${{ env.source_branch }}"
            echo "ğŸ“Œ ç›®æ ‡ä»“åº“ï¼š${{ env.target_user }}/${{ env.target_repo }}:${{ env.target_branch }}"
            echo "ğŸ“Œ åŒæ­¥ç­–ç•¥ï¼š${{ inputs.sync_strategy }}"
          else
            echo "â„¹ï¸ ${{ env.target_repo }}ï¼šæºæ–‡ä»¶ä¸ç›®æ ‡æ–‡ä»¶å®Œå…¨ä¸€è‡´ï¼ˆæ—¶é—´æˆ³+å¤§å°åŒ¹é…ï¼‰ï¼Œæ— éœ€åŒæ­¥"
          fi

  # æœ€ç»ˆæ±‡æ€»æŠ¥å‘Š
  summary:
    runs-on: ubuntu-latest
    needs: sync
    if: always()
    steps:
      - name: ğŸ“‹ åŒæ­¥ä»»åŠ¡æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "## ğŸ”„ æ‰¹é‡åŒæ­¥ä»»åŠ¡å®ŒæˆæŠ¥å‘Š"
          echo "---"
          echo "**æ‰§è¡Œæ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          echo "**åŒæ­¥ç­–ç•¥ï¼š** ${{ inputs.sync_strategy }}"
          echo "**æäº¤æ¨¡æ¿ï¼š** ${{ inputs.commit_template }}"
          echo ""
          echo "### ğŸ“Š åŒæ­¥ä»“åº“ï¼š"
          echo "- core"
          echo "- inbox"
          echo "- update"
          echo "- xiaoran37"
          echo "- xiaoran67"
          echo ""
          echo "---"
          echo "ç”± GitHub Actions Sync Bot è‡ªåŠ¨æ‰§è¡Œ"
