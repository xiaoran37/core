name: 'ğŸ”„ GitHub â†’ GitHub Batch Sync Force'
# name: 'ğŸ”„ GitHub â†’ GitHub æ‰¹é‡å¼ºåˆ¶è¦†ç›–åŒæ­¥'

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“ä¿¡æ¯ï¼ˆç”¨æˆ·/ä»“åº“å@åˆ†æ”¯ï¼‰'
        type: string
        required: true
        default: 'xiaoran67/core@main'
      source_folder:
        description: 'æºä»“åº“åŒæ­¥è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        type: string
        required: false
        default: ''
      source_token_name:
        description: 'æºä»“åº“Tokençš„Secretåç§°'
        type: string
        required: true
        default: 'XIAORAN67_GITHUB_TOKEN'

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target_config:
          - {user: 'xiaoran29', repo: 'update', branch: 'main', token_name: 'XIAORAN29_GITHUB_TOKEN'}
          - {user: 'xiaoran29', repo: 'core', branch: 'main', token_name: 'XIAORAN29_GITHUB_TOKEN'}
          - {user: 'xiaoran37', repo: 'update', branch: 'main', token_name: 'XIAORAN37_GITHUB_TOKEN'}
          - {user: 'xiaoran37', repo: 'core', branch: 'main', token_name: 'XIAORAN37_GITHUB_TOKEN'}
          - {user: 'xiaoran67', repo: 'update', branch: 'main', token_name: 'XIAORAN67_GITHUB_TOKEN'}
          - {user: 'xiaoran85', repo: 'update', branch: 'main', token_name: 'XIAORAN85_GITHUB_TOKEN'}
          - {user: 'xiaoran85', repo: 'core', branch: 'main', token_name: 'XIAORAN85_GITHUB_TOKEN'}
          - {user: 'xiaoran012', repo: 'update', branch: 'main', token_name: 'XIAORAN012_GITHUB_TOKEN'}
          - {user: 'xiaoran012', repo: 'core', branch: 'main', token_name: 'XIAORAN012_GITHUB_TOKEN'}
          - {user: 'xiaoran077', repo: 'update', branch: 'main', token_name: 'XIAORAN077_GITHUB_TOKEN'}
          - {user: 'xiaoran077', repo: 'core', branch: 'main', token_name: 'XIAORAN077_GITHUB_TOKEN'}
          - {user: 'xiaoranmuze', repo: 'update', branch: 'main', token_name: 'XIAORANMUZE_GITHUB_TOKEN'}
          - {user: 'xiaoranmuze', repo: 'core', branch: 'main', token_name: 'XIAORANMUZE_GITHUB_TOKEN'}
    
    steps:
      # 1. ç”Ÿæˆç»Ÿä¸€åŒæ­¥æ—¶é—´
      - name: â° ç”Ÿæˆç»Ÿä¸€åŒæ­¥æ—¶é—´
        id: sync_time
        run: |
          SYNC_TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          echo "ğŸ• æœ¬æ¬¡åŒæ­¥åŸºå‡†æ—¶é—´: $SYNC_TIMESTAMP"
          echo "SYNC_TIMESTAMP=$SYNC_TIMESTAMP" >> $GITHUB_ENV
          echo "timestamp=$SYNC_TIMESTAMP" >> $GITHUB_OUTPUT

      # 2. è§£ææºä»“åº“
      - name: ğŸ§© è§£ææºä»“åº“
        id: parse_source
        run: |
          if ! echo "${INPUT_SOURCE_REPO}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            echo "âŒ é”™è¯¯ï¼šæºä»“åº“æ ¼å¼åº”ä¸º ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯" && exit 1
          fi
          IFS='/@' read -r source_user source_repo source_branch <<< "${INPUT_SOURCE_REPO}"
          echo "source_user=${source_user}" >> $GITHUB_ENV
          echo "source_repo=${source_repo}" >> $GITHUB_ENV
          echo "source_branch=${source_branch}" >> $GITHUB_ENV
        env:
          INPUT_SOURCE_REPO: ${{ inputs.source_repo }}

      # 3. è®¾ç½®ç›®æ ‡ä»“åº“å˜é‡
      - name: ğŸ¯ è®¾ç½®ç›®æ ‡ä»“åº“ä¿¡æ¯
        run: |
          echo "target_user=${{ matrix.target_config.user }}" >> $GITHUB_ENV
          echo "target_repo=${{ matrix.target_config.repo }}" >> $GITHUB_ENV
          echo "target_branch=${{ matrix.target_config.branch }}" >> $GITHUB_ENV
          echo "target_token_name=${{ matrix.target_config.token_name }}" >> $GITHUB_ENV
          echo "target_repo_token=${{ secrets[matrix.target_config.token_name] }}" >> $GITHUB_ENV

      # 4. æ ¡éªŒTokenå­˜åœ¨æ€§
      - name: ğŸ”‘ æ ¡éªŒToken
        run: |
          echo "æ£€æŸ¥æºä»“åº“Token: ${{ inputs.source_token_name }}"
          if [ -z "${{ secrets[inputs.source_token_name] }}" ]; then
            echo "âŒ é”™è¯¯ï¼šæºä»“åº“Token '${{ inputs.source_token_name }}' ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "æ£€æŸ¥ç›®æ ‡ä»“åº“Token: ${{ env.target_token_name }}"
          if [ -z "${{ secrets[env.target_token_name] }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç›®æ ‡ä»“åº“Token '${{ env.target_token_name }}' ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 5. æ£€æŸ¥å¹¶å‡†å¤‡ç›®æ ‡ä»“åº“ï¼ˆä¿®å¤åˆ†æ”¯é—®é¢˜ï¼‰
      - name: ğŸ’£ æ£€æŸ¥å¹¶å‡†å¤‡ç›®æ ‡ä»“åº“
        id: prepare_repo
        run: |
          TARGET_TOKEN="${{ env.target_repo_token }}"
          
          echo "=== å¤„ç†ç›®æ ‡ä»“åº“: ${{ env.target_user }}/${{ env.target_repo }} ==="
          
          # æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TARGET_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ env.target_user }}/${{ env.target_repo }}")
          
          echo "ä»“åº“çŠ¶æ€ç : $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 404 ]; then
            echo "ğŸ“¦ ä»“åº“ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä»“åº“..."
            
            CREATE_BODY=$(jq -n \
              --arg name "${{ env.target_repo }}" \
              --argjson private false \
              --arg default_branch "${{ env.target_branch }}" \
              '{
                "name": $name,
                "private": $private,
                "auto_init": true,
                "default_branch": $default_branch
              }')
            
            echo "åˆ›å»ºè¯·æ±‚ä½“: $CREATE_BODY"
            
            CREATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Authorization: token $TARGET_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/user/repos" \
              -d "$CREATE_BODY")
            
            HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$CREATE_RESPONSE" | head -n -1)
            
            echo "åˆ›å»ºå“åº”ç : $HTTP_CODE"
            echo "åˆ›å»ºå“åº”ä½“: $RESPONSE_BODY"
            
            if [ "$HTTP_CODE" -eq 201 ]; then
              echo "âœ… ä»“åº“åˆ›å»ºæˆåŠŸ"
              echo "REPO_CREATED=true" >> $GITHUB_OUTPUT
              echo "NEEDS_EMPTY_COMMIT=false" >> $GITHUB_OUTPUT
              sleep 3  # ç­‰å¾…GitHubå¤„ç†
            else
              echo "âŒ ä»“åº“åˆ›å»ºå¤±è´¥"
              exit 1
            fi
            
          elif [ "$HTTP_STATUS" -eq 200 ]; then
            echo "ğŸ“ ä»“åº“å·²å­˜åœ¨"
            echo "REPO_CREATED=false" >> $GITHUB_OUTPUT
            echo "NEEDS_EMPTY_COMMIT=false" >> $GITHUB_OUTPUT
            
            # ä¸éœ€è¦æ¸…ç©ºï¼Œç›´æ¥è¦†ç›–å³å¯
            echo "â„¹ï¸ ä»“åº“å·²å­˜åœ¨ï¼Œå°†ç›´æ¥è¦†ç›–å†…å®¹"
            
          else
            echo "âŒ æ— æ³•è®¿é—®ä»“åº“ï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
            exit 1
          fi

      # 6. å…‹éš†æºä»“åº“
      - name: ğŸ“¥ å…‹éš†æºä»“åº“
        run: |
          echo "=== å…‹éš†æºä»“åº“ ==="
          rm -rf source_repo
          
          SOURCE_TOKEN="${{ secrets[inputs.source_token_name] }}"
          echo "ä½¿ç”¨Token: ${{ inputs.source_token_name }}"
          
          git clone \
            --branch "${{ env.source_branch }}" \
            --depth 1 \
            --quiet \
            "https://$SOURCE_TOKEN@github.com/${{ env.source_user }}/${{ env.source_repo }}.git" \
            source_repo
          
          echo "âœ… æºä»“åº“å…‹éš†å®Œæˆ"
          echo "æºä»“åº“è·¯å¾„: $(pwd)/source_repo"
          ls -la source_repo/

      # 7. å‡†å¤‡ç›®æ ‡æ–‡ä»¶
      - name: ğŸ“ å‡†å¤‡ç›®æ ‡æ–‡ä»¶
        run: |
          echo "=== å‡†å¤‡ç›®æ ‡æ–‡ä»¶ ==="
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf target_prepared
          mkdir -p target_prepared
          
          # ç¡®å®šæºè·¯å¾„
          if [ -z "${{ inputs.source_folder }}" ] || [ "${{ inputs.source_folder }}" = "/" ]; then
            SOURCE_PATH="source_repo"
          else
            SOURCE_PATH="source_repo/${{ inputs.source_folder }}"
          fi
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_PATH" ] && [ ! -f "$SOURCE_PATH" ]; then
            echo "âŒ é”™è¯¯ï¼šæºè·¯å¾„ä¸å­˜åœ¨: $SOURCE_PATH"
            ls -la source_repo/
            exit 1
          fi
          
          # å¤åˆ¶æ–‡ä»¶
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•..."
          
          if [ -d "$SOURCE_PATH" ]; then
            # å¦‚æœæ˜¯ç›®å½•ï¼Œå¤åˆ¶æ•´ä¸ªç›®å½•
            cp -r "$SOURCE_PATH/." target_prepared/
          else
            # å¦‚æœæ˜¯å•ä¸ªæ–‡ä»¶ï¼Œå¤åˆ¶æ–‡ä»¶
            cp "$SOURCE_PATH" target_prepared/
          fi
          
          # ç¡®ä¿æ²¡æœ‰.gitç›®å½•è¢«å¤åˆ¶
          rm -rf target_prepared/.git 2>/dev/null || true
          
          echo "âœ… æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          echo "ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -la target_prepared/
          echo "æ–‡ä»¶æ•°é‡: $(find target_prepared -type f | wc -l)"

      # 8. åˆ›å»ºæ–°Gitä»“åº“å¹¶æ¨é€ï¼ˆæ ¸å¿ƒä¿®å¤æ­¥éª¤ï¼‰
      - name: ğŸ“¤ åˆ›å»ºå¹¶æ¨é€Gitä»“åº“
        run: |
          echo "=== åˆ›å»ºGitä»“åº“å¹¶æ¨é€ ==="
          
          cd target_prepared
          
          # åˆå§‹åŒ–Gitä»“åº“ï¼ŒæŒ‡å®šåˆ†æ”¯
          echo "åˆå§‹åŒ–Gitä»“åº“ï¼Œåˆ†æ”¯: ${{ env.target_branch }}"
          git init
          git checkout -b "${{ env.target_branch }}" 2>/dev/null || git branch -M "${{ env.target_branch }}"
          
          # é…ç½®Gitç”¨æˆ·
          git config user.name "Sync Bot"
          git config user.email "sync@noreply.github.com"
          
          # è®¾ç½®ç»Ÿä¸€çš„æ—¶é—´ç¯å¢ƒå˜é‡
          export GIT_AUTHOR_DATE="${{ env.SYNC_TIMESTAMP }}"
          export GIT_COMMITTER_DATE="${{ env.SYNC_TIMESTAMP }}"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          echo "æ·»åŠ æ–‡ä»¶åˆ°Git..."
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¯æäº¤
          if git status --porcelain | grep -q .; then
            echo "æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ‰§è¡Œæäº¤"
          else
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåˆ›å»ºç©ºæäº¤"
            touch .sync_empty
            git add .sync_empty
          fi
          
          # æäº¤ï¼ˆå¼ºåˆ¶ä½¿ç”¨ç»Ÿä¸€æ—¶é—´ï¼‰
          COMMIT_MSG="â˜˜ï¸ ${{ env.SYNC_TIMESTAMP }}"
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          git commit -m "$COMMIT_MSG" \
            --date="${{ env.SYNC_TIMESTAMP }}"
          
          # æ·»åŠ è¿œç¨‹ä»“åº“
          TARGET_TOKEN="${{ env.target_repo_token }}"
          REPO_URL="https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
          
          echo "æ·»åŠ è¿œç¨‹ä»“åº“: ${{ env.target_user }}/${{ env.target_repo }}"
          git remote add origin "$REPO_URL"
          
          # å¼ºåˆ¶æ¨é€
          echo "ğŸš€ å¼ºåˆ¶æ¨é€ä¸­..."
          git push --force --set-upstream origin "${{ env.target_branch }}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… æ¨é€æˆåŠŸ"
            echo "â˜˜ï¸ ${{ env.SYNC_TIMESTAMP }}"
            
            # æ˜¾ç¤ºæäº¤ä¿¡æ¯
            echo "ğŸ“‹ æäº¤è¯¦æƒ…:"
            git log --oneline -1
          else
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi

      # 9. éªŒè¯æ¨é€ç»“æœ
      - name: âœ… éªŒè¯æ¨é€ç»“æœ
        run: |
          echo "=== éªŒè¯æ¨é€ç»“æœ ==="
          
          TARGET_TOKEN="${{ env.target_repo_token }}"
          
          # ä¸´æ—¶éªŒè¯å…‹éš†
          rm -rf verify_repo
          
          if git clone --quiet --depth 1 \
            "https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git" \
            verify_repo 2>/dev/null; then
            
            cd verify_repo
            echo "âœ… ä»“åº“å¯è®¿é—®"
            echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "ğŸ“ æœ€æ–°æäº¤: $(git log --oneline -1)"
            echo "ğŸ“ æ–‡ä»¶æ•°: $(find . -type f ! -path './.git/*' | wc -l)"
            
            # æ£€æŸ¥æäº¤æ—¶é—´
            COMMIT_DATE=$(git log -1 --format="%ad" --date=short)
            COMMIT_TIME=$(git log -1 --format="%ad" --date=format:'%H:%M:%S')
            echo "ğŸ• æäº¤æ—¥æœŸ: $COMMIT_DATE $COMMIT_TIME"
            
            cd ..
            rm -rf verify_repo
          else
            echo "âš ï¸  è­¦å‘Š: æ— æ³•éªŒè¯ä»“åº“è®¿é—®"
          fi
          
          echo ""
          echo "=================== åŒæ­¥æ‘˜è¦ ==================="
          echo "âœ… åŒæ­¥å®Œæˆ: ${{ env.target_user }}/${{ env.target_repo }}"
          echo "ğŸ“… ç»Ÿä¸€æ—¶é—´: ${{ env.SYNC_TIMESTAMP }}"
          echo "ğŸ”— ä»“åº“åœ°å€: https://github.com/${{ env.target_user }}/${{ env.target_repo }}"
          echo "================================================"

      # 10. æ¸…ç†å·¥ä½œåŒº
      - name: ğŸ§¹ æ¸…ç†å·¥ä½œåŒº
        if: always()
        run: |
          echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
          rm -rf source_repo target_prepared verify_repo 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      # 11. æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
      - name: ğŸ“Š æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
        if: always()
        run: |
          echo ""
          echo "ğŸ¯ æœ¬æ¬¡åŒæ­¥è¯¦æƒ…"
          echo "â”œâ”€ æºä»“åº“: ${{ env.source_user }}/${{ env.source_repo }}@${{ env.source_branch }}"
          echo "â”œâ”€ æºè·¯å¾„: ${{ inputs.source_folder || 'æ ¹ç›®å½•' }}"
          echo "â”œâ”€ ç›®æ ‡ä»“åº“: ${{ env.target_user }}/${{ env.target_repo }}@${{ env.target_branch }}"
          echo "â”œâ”€ åŒæ­¥æ—¶é—´: ${{ env.SYNC_TIMESTAMP }}"
          echo "â””â”€ åŒæ­¥æ–¹å¼: å¼ºåˆ¶å®Œå…¨è¦†ç›–"
          echo ""
          echo "ğŸ“‹ æäº¤ä¿¡æ¯ç¤ºä¾‹:"
          echo "   â˜˜ï¸ ${{ env.SYNC_TIMESTAMP }}"
          echo ""
          echo "âœ… è¯¥ä»“åº“åŒæ­¥æµç¨‹ç»“æŸ"
