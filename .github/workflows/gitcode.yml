name: GitHub to GitCode Force Sync

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup GitCode remote
      env:
        GC_TOKEN: ${{ secrets.XIAORAN79_GITCODE_TOKEN }}
      run: |
        mkdir -p gitcode-sync
        cd gitcode-sync
        git init
        git remote add origin https://xiaoran79:$GC_TOKEN@gitcode.net/xiaoran79/update.git
        
        # 尝试拉取现有内容
        git fetch origin main --depth=1 2>/dev/null || {
          echo "仓库不存在或空仓库"
          git checkout -b main
          echo "# GitCode 同步仓库" > README.md
          git add README.md
          git commit -m "初始提交"
        }
        
        # 备份.git
        cp -r .git ../.git-backup
        
        # 清空并复制
        find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
        cp -r ../* .
        rm -rf .git
        mv ../.git-backup .git
        
        # 提交并强制推送
        git add -A
        if ! git diff-index --quiet HEAD --; then
          git commit -m "覆盖同步 $(date)"
          git push origin main --force
        fi
