name: 'ğŸš€ è·¨ä»“åº“å¤šå¹³å°åŒæ­¥'

on:
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'æ˜¯å¦åŒæ­¥æ‰€æœ‰ä»“åº“'
        type: boolean
        required: true
        default: true
      
      specific_sync:
        description: 'é€‰æ‹©ç‰¹å®šåŒæ­¥ä»»åŠ¡ï¼ˆä»…å½“sync_all=falseæ—¶æœ‰æ•ˆï¼‰'
        type: choice
        required: false
        default: 'core'
        options:
          - 'core'
          - 'update'
          - 'xiaoran37'
          - 'xiaoran67'
      
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        type: choice
        required: true
        default: 'è¦†ç›–'
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
      
      source_folder:
        description: 'æºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¤šçº§ç›®å½•ç”¨/åˆ†éš”ï¼Œç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      target_folder:
        description: 'ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¤šçº§ç›®å½•ç”¨/åˆ†éš”ï¼Œç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: ''
        type: string
      
      target_platform:
        description: 'ç›®æ ‡ä»“åº“å¹³å°'
        type: choice
        required: true
        default: 'github'
        options:
          - 'github'
          - 'gitee'
          - 'gitcode'
      
      commit_message:
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date} {source} {target}ï¼‰'
        required: false
        default: 'ğŸ”„ {date} {time}'
        type: string

env:
  SOURCE_ACCOUNT: 'xiaoran67'  # GitHubæºè´¦æˆ·
  SOURCE_TOKEN_NAME: 'XIAORAN67_GITHUB_TOKEN'
  BRANCH: 'main'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { repo: 'core', description: 'æ ¸å¿ƒä»“åº“' }
          - { repo: 'update', description: 'æ›´æ–°ä»“åº“' }
          - { repo: 'xiaoran37', description: 'ä¸»ä»“åº“' }
          - { repo: 'xiaoran67', description: 'é…ç½®ä»“åº“' }
    
    steps:
      # 1. æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œå½“å‰ä»“åº“çš„åŒæ­¥
      - name: ğŸ” æ£€æŸ¥æ‰§è¡Œæ¡ä»¶
        id: check_condition
        run: |
          REPO_NAME="${{ matrix.repo }}"
          
          # å¦‚æœé€‰æ‹©åŒæ­¥æ‰€æœ‰ï¼Œæˆ–è€…é€‰æ‹©ç‰¹å®šä»»åŠ¡ä¸”ä¸å½“å‰ä»“åº“åŒ¹é…
          if [ "${{ github.event.inputs.sync_all }}" = "true" ] || [ "${{ github.event.inputs.specific_sync }}" = "$REPO_NAME" ]; then
            echo "âœ… æ‰§è¡ŒåŒæ­¥ï¼š$REPO_NAME"
            echo "should_run=true" >> $GITHUB_ENV
            echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
            echo "REPO_DESC=${{ matrix.description }}" >> $GITHUB_ENV
          else
            echo "â­ï¸ è·³è¿‡åŒæ­¥ï¼š$REPO_NAME"
            echo "should_run=false" >> $GITHUB_ENV
          fi

      # 2. è®¾ç½®ä»“åº“é…ç½®ï¼ˆæ ¹æ®å¹³å°è°ƒæ•´ç›®æ ‡è´¦æˆ·ï¼‰
      - name: ğŸ§© è®¾ç½®ä»“åº“é…ç½®
        if: env.should_run == 'true'
        run: |
          echo "=== ä»“åº“é…ç½® ==="
          echo "ä»“åº“æè¿°: ${{ env.REPO_DESC }}"
          echo "æºä»“åº“: ${{ env.SOURCE_ACCOUNT }}/${{ env.REPO_NAME }}@${{ env.BRANCH }}"
          
          # æ ¹æ®ç›®æ ‡å¹³å°è®¾ç½®ç›®æ ‡è´¦æˆ·
          TARGET_PLATFORM="${{ github.event.inputs.target_platform }}"
          
          case "$TARGET_PLATFORM" in
            "github")
              TARGET_ACCOUNT="xiaoran37"
              TARGET_TOKEN_NAME="XIAORAN37_GITHUB_TOKEN"
              echo "ç›®æ ‡å¹³å°: GitHub (è´¦æˆ·: $TARGET_ACCOUNT)"
              ;;
            "gitee")
              TARGET_ACCOUNT="xiaoran67"  # Giteeè´¦æˆ·ä¸GitHubæºè´¦æˆ·ç›¸åŒ
              TARGET_TOKEN_NAME="XIAORAN67_GITEE_TOKEN"  # éœ€è¦ä¸åŒçš„Tokenåç§°
              echo "ç›®æ ‡å¹³å°: Gitee (è´¦æˆ·: $TARGET_ACCOUNT)"
              ;;
            "gitcode")
              TARGET_ACCOUNT="xiaoran37"  # GitCodeä½¿ç”¨GitHubè´¦æˆ·å
              TARGET_TOKEN_NAME="XIAORAN37_GITCODE_TOKEN"  # éœ€è¦ä¸åŒçš„Tokenåç§°
              echo "ç›®æ ‡å¹³å°: GitCode (è´¦æˆ·: $TARGET_ACCOUNT)"
              ;;
          esac
          
          echo "ç›®æ ‡ä»“åº“: $TARGET_ACCOUNT/${{ env.REPO_NAME }}@${{ env.BRANCH }}"
          
          # åŸºç¡€é…ç½®
          echo "source_user=${{ env.SOURCE_ACCOUNT }}" >> $GITHUB_ENV
          echo "source_repo=${{ env.REPO_NAME }}" >> $GITHUB_ENV
          echo "source_branch=${{ env.BRANCH }}" >> $GITHUB_ENV
          
          echo "target_user=$TARGET_ACCOUNT" >> $GITHUB_ENV
          echo "target_repo=${{ env.REPO_NAME }}" >> $GITHUB_ENV
          echo "target_branch=${{ env.BRANCH }}" >> $GITHUB_ENV
          
          echo "source_token_name=${{ env.SOURCE_TOKEN_NAME }}" >> $GITHUB_ENV
          echo "target_token_name=$TARGET_TOKEN_NAME" >> $GITHUB_ENV
          
          # æ–‡ä»¶å¤¹è·¯å¾„å¤„ç†
          SOURCE_FOLDER=$(echo "${{ github.event.inputs.source_folder }}" | xargs)
          if [ -z "$SOURCE_FOLDER" ] || [ "$SOURCE_FOLDER" = "." ]; then
            echo "source_folder=" >> $GITHUB_ENV
          else
            SOURCE_FOLDER=$(echo "$SOURCE_FOLDER" | sed 's|^/||' | sed 's|/$||')
            echo "source_folder=$SOURCE_FOLDER" >> $GITHUB_ENV
          fi
          
          TARGET_FOLDER=$(echo "${{ github.event.inputs.target_folder }}" | xargs)
          if [ -z "$TARGET_FOLDER" ] || [ "$TARGET_FOLDER" = "." ]; then
            echo "target_folder=" >> $GITHUB_ENV
          else
            TARGET_FOLDER=$(echo "$TARGET_FOLDER" | sed 's|^/||' | sed 's|/$||')
            echo "target_folder=$TARGET_FOLDER" >> $GITHUB_ENV
          fi
          
          # åŒæ­¥ç­–ç•¥å’Œå¹³å°
          echo "sync_mode=${{ github.event.inputs.sync_mode }}" >> $GITHUB_ENV
          echo "target_platform=${{ github.event.inputs.target_platform }}" >> $GITHUB_ENV
          echo "commit_message=${{ github.event.inputs.commit_message }}" >> $GITHUB_ENV

      # 3. æ ¡éªŒToken
      - name: ğŸ”‘ æ ¡éªŒTokenæœ‰æ•ˆæ€§
        if: env.should_run == 'true'
        run: |
          echo "=== Tokenæ ¡éªŒ ==="
          SOURCE_TOKEN_NAME="${{ env.source_token_name }}"
          TARGET_TOKEN_NAME="${{ env.target_token_name }}"
          
          if [ -z "${{ secrets[env.source_token_name] }}" ]; then
            echo "âŒ æºä»“åº“Tokenä¸å­˜åœ¨: $SOURCE_TOKEN_NAME"
            echo "è¯·æ£€æŸ¥GitHub Secretsä¸­æ˜¯å¦æœ‰ $SOURCE_TOKEN_NAME"
            exit 1
          fi
          
          if [ -z "${{ secrets[env.target_token_name] }}" ]; then
            echo "âŒ ç›®æ ‡ä»“åº“Tokenä¸å­˜åœ¨: $TARGET_TOKEN_NAME"
            echo "è¯·æ£€æŸ¥GitHub Secretsä¸­æ˜¯å¦æœ‰ $TARGET_TOKEN_NAME"
            echo ""
            echo "éœ€è¦åˆ›å»ºçš„Token:"
            case "${{ env.target_platform }}" in
              "github")
                echo "- $TARGET_TOKEN_NAME: GitHubä¸ªäººè®¿é—®ä»¤ç‰Œï¼Œéœ€è¦æœ‰repoæƒé™"
                ;;
              "gitee")
                echo "- $TARGET_TOKEN_NAME: Giteeç§äººä»¤ç‰Œï¼Œéœ€è¦æœ‰projectsæƒé™"
                ;;
              "gitcode")
                echo "- $TARGET_TOKEN_NAME: GitCodeç§äººä»¤ç‰Œï¼Œéœ€è¦æœ‰ä»“åº“è¯»å†™æƒé™"
                ;;
            esac
            exit 1
          fi
          
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      # 4. æ£€æŸ¥/åˆ›å»ºç›®æ ‡ä»“åº“ï¼ˆä»…GitHubå¹³å°ï¼‰
      - name: ğŸ“¦ æ£€æŸ¥å¹¶åˆ›å»ºç›®æ ‡ä»“åº“
        if: env.should_run == 'true' && env.target_platform == 'github'
        run: |
          echo "=== æ£€æŸ¥ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          
          REPO_CHECK_URL="https://api.github.com/repos/${{ env.target_user }}/${{ env.target_repo }}"
          REPO_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TARGET_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$REPO_CHECK_URL")
          
          if [ "$REPO_EXISTS" -eq 404 ]; then
            echo "â„¹ï¸ ç›®æ ‡ä»“åº“ ${{ env.target_repo }} ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»º..."
            CREATE_BODY=$(jq -n \
              --arg name "${{ env.target_repo }}" \
              --arg default_branch "${{ env.target_branch }}" \
              '{"name": $name, "private": false, "auto_init": true, "default_branch": $default_branch}')
            
            CREATE_RESPONSE=$(curl -s -w "%{http_code}" -o create_result.json \
              -X POST \
              -H "Authorization: token $TARGET_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/user/repos" \
              -d "$CREATE_BODY")
            
            if [ "$CREATE_RESPONSE" -eq 201 ]; then
              echo "âœ… ç›®æ ‡ä»“åº“ ${{ env.target_repo }} åˆ›å»ºæˆåŠŸ"
            else
              echo "âš ï¸ ç›®æ ‡ä»“åº“åˆ›å»ºå¤±è´¥ï¼Œå°†ç»§ç»­å°è¯•åŒæ­¥"
              echo "å“åº”: $(cat create_result.json 2>/dev/null || echo 'æœªçŸ¥é”™è¯¯')"
            fi
          elif [ "$REPO_EXISTS" -eq 200 ]; then
            echo "âœ… ç›®æ ‡ä»“åº“ ${{ env.target_repo }} å·²å­˜åœ¨"
          else
            echo "âš ï¸ æ£€æŸ¥ä»“åº“çŠ¶æ€å¤±è´¥ï¼ŒHTTPç ï¼š$REPO_EXISTS"
            echo "âš ï¸ å°†ç»§ç»­å°è¯•åŒæ­¥"
          fi

      # 5. å®‰è£…å¿…è¦å·¥å…·
      - name: ğŸ› ï¸ å®‰è£…åŒæ­¥å·¥å…·
        if: env.should_run == 'true'
        run: |
          echo "=== å®‰è£…å·¥å…· ==="
          sudo apt-get update
          sudo apt-get install -y rsync tree jq curl
          echo "âœ… å¿…è¦å·¥å…·å®‰è£…å®Œæˆ"

      # 6. æ£€å‡ºæºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºæºä»“åº“
        if: env.should_run == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.source_user }}/${{ env.source_repo }}
          ref: ${{ env.source_branch }}
          path: source_repo
          token: ${{ secrets[env.source_token_name] }}
          fetch-depth: 0
          clean: true

      # 7. å‡†å¤‡ç›®æ ‡ä»“åº“ï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
      - name: ğŸ“¦ å‡†å¤‡ç›®æ ‡ä»“åº“
        if: env.should_run == 'true'
        run: |
          echo "=== å‡†å¤‡ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          
          # æ ¹æ®ç›®æ ‡å¹³å°æ„å»ºURL
          case "${{ env.target_platform }}" in
            "github")
              TARGET_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              echo "ä½¿ç”¨GitHubå¹³å°"
              ;;
            "gitee")
              # Giteeçš„URLæ ¼å¼ï¼šhttps://ç”¨æˆ·å:token@gitee.com/ç”¨æˆ·å/ä»“åº“å.git
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              echo "ä½¿ç”¨Giteeå¹³å°ï¼ˆè´¦æˆ·: ${{ env.target_user }}ï¼‰"
              ;;
            "gitcode")
              # GitCodeçš„URLæ ¼å¼ï¼šhttps://ç”¨æˆ·å:token@gitcode.com/ç”¨æˆ·å/ä»“åº“å.git
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              echo "ä½¿ç”¨GitCodeå¹³å°"
              ;;
          esac
          
          echo "ç›®æ ‡ä»“åº“URL: $TARGET_URL"
          
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆæ·»åŠ å®¹é”™å¤„ç†ï¼‰
          set +e
          git clone --branch ${{ env.target_branch }} --depth=1 "$TARGET_URL" target_repo 2>/dev/null
          CLONE_STATUS=$?
          set -e
          
          if [ $CLONE_STATUS -ne 0 ]; then
            echo "âš ï¸ ç›®æ ‡ä»“åº“å…‹éš†å¤±è´¥ï¼Œå°è¯•åˆå§‹åŒ–..."
            rm -rf target_repo
            mkdir -p target_repo
            cd target_repo
            git init
            git remote add origin "$TARGET_URL"
            git checkout -b ${{ env.target_branch }} || git checkout -b main
            cd ..
            echo "â„¹ï¸ å·²åˆå§‹åŒ–ç©ºä»“åº“"
          else
            echo "âœ… ç›®æ ‡ä»“åº“å…‹éš†æˆåŠŸ"
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          if [ -n "${{ env.target_folder }}" ]; then
            mkdir -p "target_repo/${{ env.target_folder }}"
          fi

      # 8. æ‰§è¡Œæ–‡ä»¶åŒæ­¥
      - name: ğŸ”„ æ‰§è¡Œæ–‡ä»¶åŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°æ ¡éªŒï¼‰
        if: env.should_run == 'true'
        run: |
          echo "=== æ‰§è¡Œæ–‡ä»¶åŒæ­¥ ==="
          echo "åŒæ­¥æ¨¡å¼: ${{ env.sync_mode }}"
          
          # æ„å»ºæºè·¯å¾„å’Œç›®æ ‡è·¯å¾„
          SOURCE_PATH="source_repo"
          TARGET_PATH="target_repo"
          
          if [ -n "${source_folder:+x}" ]; then
            SOURCE_PATH="source_repo/${{ env.source_folder }}"
          fi
          
          if [ -n "${target_folder:+x}" ]; then
            TARGET_PATH="target_repo/${{ env.target_folder }}"
          fi
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨
          if [ ! -e "$SOURCE_PATH" ]; then
            echo "âŒ æºè·¯å¾„ä¸å­˜åœ¨: $SOURCE_PATH"
            echo "æºä»“åº“å†…å®¹:"
            ls -la source_repo/
            exit 1
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "$TARGET_PATH"
          
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼æ‰§è¡Œä¸åŒçš„rsyncå‘½ä»¤
          if [ "${{ env.sync_mode }}" = "å¢é‡" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¢é‡åŒæ­¥ï¼ˆæ—¶é—´æˆ³+å¤§å°æ ¡éªŒï¼‰"
            rsync -av --times --exclude=".git/" "$SOURCE_PATH/" "$TARGET_PATH/"
          else
            echo "ğŸ”„ æ‰§è¡Œè¦†ç›–åŒæ­¥ï¼ˆä½¿ç›®æ ‡ä¸æºå®Œå…¨ä¸€è‡´ï¼‰"
            rsync -av --delete --force --times --exclude=".git/" "$SOURCE_PATH/" "$TARGET_PATH/"
          fi
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          
          # æ˜¾ç¤ºåŒæ­¥ç»Ÿè®¡
          echo "=== åŒæ­¥ç»Ÿè®¡ ==="
          echo "ç›®æ ‡ç›®å½•æ–‡ä»¶æ•°: $(find "$TARGET_PATH" -type f | wc -l)"
          echo "ç›®æ ‡ç›®å½•å¤§å°: $(du -sh "$TARGET_PATH" | cut -f1)"

      # 9. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–
        if: env.should_run == 'true'
        id: check_changes
        run: |
          echo "=== æ£€æŸ¥æ–‡ä»¶å˜åŒ– ==="
          cd target_repo
          
          # è®¾ç½®Gité…ç½®
          git config user.name "Auto Sync Bot"
          git config user.email "sync-bot@noreply.github.com"
          
          # æ£€æŸ¥gitçŠ¶æ€
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦æäº¤"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå…·ä½“å˜åŒ–
            echo "=== å…·ä½“å˜åŒ– ==="
            git status -s
            echo "å˜åŒ–æ–‡ä»¶æ•°: $(git status -s | wc -l)"
          else
            echo "âœ… æ— æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      # 10. æäº¤å’Œæ¨é€å˜åŒ–
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ”¹
        if: env.should_run == 'true' && steps.check_changes.outputs.changes_detected == 'true'
        run: |
          echo "=== æäº¤æ›´æ”¹ ==="
          cd target_repo
          
          # é…ç½®Gitç”¨æˆ·ï¼ˆå†æ¬¡ç¡®è®¤ï¼‰
          git config user.name "Auto Sync Bot"
          git config user.email "sync-bot@noreply.github.com"
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          COMMIT_MSG="${{ env.commit_message }}"
          
          # æ›¿æ¢æ¨¡æ¿å˜é‡
          COMMIT_MSG="${COMMIT_MSG//\{time\}/$CURRENT_TIME}"
          COMMIT_MSG="${COMMIT_MSG//\{date\}/$CURRENT_DATE}"
          COMMIT_MSG="${COMMIT_MSG//\{source\}/${{ env.source_user }}/${{ env.source_repo }}:${{ env.source_branch }}}"
          COMMIT_MSG="${COMMIT_MSG//\{target\}/${{ env.target_user }}/${{ env.target_repo }}:${{ env.target_branch }}}"
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add -A
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ç›®æ ‡ä»“åº“
          echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          
          case "${{ env.target_platform }}" in
            "github")
              PUSH_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitee")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitcode")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
          esac
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼å†³å®šæ˜¯å¦å¼ºåˆ¶æ¨é€
          if [ "${{ env.sync_mode }}" = "è¦†ç›–" ]; then
            echo "ğŸ”„ è¦†ç›–æ¨¡å¼ï¼Œä½¿ç”¨å¼ºåˆ¶æ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }} --force
          else
            echo "ğŸ”„ å¢é‡æ¨¡å¼ï¼Œä½¿ç”¨æ™®é€šæ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }}
          fi
          
          echo "âœ… æ¨é€å®Œæˆ"

      # 11. ç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: ğŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: env.should_run == 'true'
        run: |
          echo "=== ğŸ”„ åŒæ­¥æŠ¥å‘Š - ${{ env.REPO_DESC }} ==="
          echo ""
          
          if [ "${{ steps.check_changes.outputs.changes_detected }}" = "true" ]; then
            echo "âœ… åŒæ­¥ä»»åŠ¡å®Œæˆ - æ£€æµ‹åˆ°å˜åŒ–å¹¶å·²æäº¤"
            COMMIT_HASH=$(cd target_repo && git log -1 --format='%H' 2>/dev/null || echo 'æ— æäº¤')
            echo "ğŸ“ æäº¤å“ˆå¸Œ: $COMMIT_HASH"
          else
            echo "â„¹ï¸ åŒæ­¥ä»»åŠ¡å®Œæˆ - æ— å˜åŒ–"
          fi
          
          echo ""
          echo "ğŸ“Œ åŒæ­¥æ¨¡å¼: ${{ env.sync_mode }}"
          echo ""
          echo "ğŸ“¥ æºä»“åº“:"
          echo "   å¹³å°: GitHub"
          echo "   è´¦æˆ·: ${{ env.source_user }}"
          echo "   ä»“åº“: ${{ env.source_repo }}"
          echo "   åˆ†æ”¯: ${{ env.source_branch }}"
          echo "   ç›®å½•: ${{ env.source_folder || 'æ ¹ç›®å½•' }}"
          echo ""
          echo "ğŸ“¤ ç›®æ ‡ä»“åº“:"
          echo "   å¹³å°: ${{ env.target_platform }}"
          echo "   è´¦æˆ·: ${{ env.target_user }}"
          echo "   ä»“åº“: ${{ env.target_repo }}"
          echo "   åˆ†æ”¯: ${{ env.target_branch }}"
          echo "   ç›®å½•: ${{ env.target_folder || 'æ ¹ç›®å½•' }}"
          echo ""
          echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

  # 12. æœ€ç»ˆæ±‡æ€»æŠ¥å‘Š
  summary:
    runs-on: ubuntu-latest
    needs: sync
    if: always()
    steps:
      - name: ğŸ“‹ æ‰¹é‡åŒæ­¥æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "## ğŸš€ è·¨ä»“åº“å¤šå¹³å°åŒæ­¥å®ŒæˆæŠ¥å‘Š"
          echo "---"
          echo "**æ‰§è¡Œæ—¶é—´ï¼š** $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "### ğŸ“Š åŒæ­¥é…ç½®"
          echo "- **åŒæ­¥æ¨¡å¼ï¼š** ${{ github.event.inputs.sync_mode }}"
          echo "- **ç›®æ ‡å¹³å°ï¼š** ${{ github.event.inputs.target_platform }}"
          echo "- **æäº¤ä¿¡æ¯ï¼š** ${{ github.event.inputs.commit_message }}"
          
          if [ "${{ github.event.inputs.sync_all }}" = "true" ]; then
            echo "- **åŒæ­¥èŒƒå›´ï¼š** æ‰€æœ‰ä»“åº“"
          else
            echo "- **åŒæ­¥èŒƒå›´ï¼š** ${{ github.event.inputs.specific_sync }} ä»“åº“"
          fi
          
          if [ -n "${{ github.event.inputs.source_folder }}" ]; then
            echo "- **æºæ–‡ä»¶å¤¹ï¼š** ${{ github.event.inputs.source_folder }}"
          fi
          
          if [ -n "${{ github.event.inputs.target_folder }}" ]; then
            echo "- **ç›®æ ‡æ–‡ä»¶å¤¹ï¼š** ${{ github.event.inputs.target_folder }}"
          fi
          
          echo ""
          echo "### ğŸ“¦ è´¦æˆ·é…ç½®"
          echo "- **æºè´¦æˆ· (GitHub)ï¼š** xiaoran67"
          
          case "${{ github.event.inputs.target_platform }}" in
            "github")
              echo "- **ç›®æ ‡è´¦æˆ· (GitHub)ï¼š** xiaoran37"
              echo "- **ç›®æ ‡Tokenï¼š** XIAORAN37_GITHUB_TOKEN"
              ;;
            "gitee")
              echo "- **ç›®æ ‡è´¦æˆ· (Gitee)ï¼š** xiaoran67"
              echo "- **ç›®æ ‡Tokenï¼š** XIAORAN67_GITEE_TOKEN"
              ;;
            "gitcode")
              echo "- **ç›®æ ‡è´¦æˆ· (GitCode)ï¼š** xiaoran37"
              echo "- **ç›®æ ‡Tokenï¼š** XIAORAN37_GITCODE_TOKEN"
              ;;
          esac
          
          echo ""
          echo "### ğŸ“ å·²åŒæ­¥ä»“åº“"
          echo "1. **core** - æ ¸å¿ƒä»“åº“"
          echo "2. **update** - æ›´æ–°ä»“åº“"
          echo "3. **xiaoran37** - ä¸»ä»“åº“"
          echo "4. **xiaoran67** - é…ç½®ä»“åº“"
          echo ""
          echo "---"
          echo "ğŸ”„ ç”±è·¨ä»“åº“å¤šå¹³å°åŒæ­¥å·¥ä½œæµè‡ªåŠ¨æ‰§è¡Œ"
          echo "âœ… æ‰€æœ‰é…ç½®çš„åŒæ­¥ä»»åŠ¡å·²å®Œæˆå¤„ç†"
